<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Respira">
<meta name="theme-color" content="#080705">
<title>Respira</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
/* â”€â”€ DARK (default) â”€â”€ */
:root {
  --bg:      #080705;
  --bg2:     #0f0e0b;
  --card:    rgba(255,248,235,0.035);
  --border:  rgba(255,248,235,0.08);
  --text:    #f0ebe2;
  --muted:   rgba(240,235,226,0.40);
  --muted2:  rgba(240,235,226,0.18);
  --amber:   #c8a26a;
  --sage:    #7a9e7e;
  --rose:    #b07a8a;
  --stone:   #9a8a78;
  --gold-ln: rgba(200,162,106,0.18);
  --noise-op: 0.025;
  --fd: 'Cormorant Garamond', Georgia, serif;
  --fm: 'DM Mono', 'Courier New', monospace;
  --range-track: rgba(255,255,255,0.12);
  --bar-bg: rgba(255,255,255,0.03);
  --prog-bg: rgba(255,255,255,0.06);
}

/* â”€â”€ LIGHT â”€â”€ */
:root.light {
â€“bg:      #f5f0e8;
â€“bg2:     #ede7da;
â€“card:    rgba(60,40,10,0.04);
â€“border:  rgba(60,40,10,0.10);
â€“text:    #1e1a14;
â€“muted:   rgba(30,26,20,0.45);
â€“muted2:  rgba(30,26,20,0.25);
â€“amber:   #9a6c32;
â€“sage:    #4a7a50;
â€“rose:    #884060;
â€“stone:   #6a5a48;
â€“gold-ln: rgba(154,108,50,0.20);
â€“noise-op: 0.015;
â€“range-track: rgba(0,0,0,0.10);
â€“bar-bg: rgba(0,0,0,0.04);
â€“prog-bg: rgba(0,0,0,0.08);
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
html {
height:100%; width:100%;
}
body {
height:100%; width:100%;
background:var(â€“bg); color:var(â€“text);
font-family:var(â€“fd);
overflow:hidden;
user-select:none; -webkit-user-select:none;
/* FIXED: removed position:fixed from body â€” causes Safari issues with fixed overlays */
position:relative;
}
body::before {
content:â€™â€™; position:fixed;
top:0; left:0; right:0; bottom:0; /* Safari fallback for inset:0 */
inset:0;
z-index:11; pointer-events:none; opacity:var(â€“noise-op);
background-image:url(â€œdata:image/svg+xml,%3Csvg viewBox=â€˜0 0 256 256â€™ xmlns=â€˜http://www.w3.org/2000/svgâ€™%3E%3Cfilter id=â€˜nâ€™%3E%3CfeTurbulence type=â€˜fractalNoiseâ€™ baseFrequency=â€˜0.85â€™ numOctaves=â€˜4â€™ stitchTiles=â€˜stitchâ€™/%3E%3C/filter%3E%3Crect width=â€˜100%25â€™ height=â€˜100%25â€™ filter=â€˜url(%23n)â€™/%3E%3C/svg%3Eâ€);
background-size:180px;
}
.screen {
position:fixed;
top:0; left:0; right:0; bottom:0; /* Safari fallback */
inset:0;
display:flex; flex-direction:column;
z-index:10;
transition:opacity .5s cubic-bezier(.4,0,.2,1), transform .5s cubic-bezier(.4,0,.2,1);
overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch;
background:var(â€“bg);
}
.screen.hidden { opacity:0; pointer-events:none; transform:translateY(22px); }

/* â”€â”€ SETUP â”€â”€ */
#setup { padding:max(env(safe-area-inset-top,0px),20px) 0 max(env(safe-area-inset-bottom,0px),32px); }

.app-header {
display:flex; flex-direction:row; align-items:center; justify-content:space-between;
padding:20px 24px 22px; flex-shrink:0; position:relative; gap:12px;
}
.app-header::after { content:â€™â€™; position:absolute; bottom:0; left:24px; right:24px; height:1px; background:var(â€“gold-ln); }
.app-title-wrap { display:flex; flex-direction:column; gap:3px; }
.app-title { font-size:clamp(40px,10.5vw,54px); font-weight:300; letter-spacing:.14em; line-height:1; }
.app-sub { font-family:var(â€“fm); font-size:8.5px; letter-spacing:.32em; color:var(â€“muted); text-transform:uppercase; }
.app-credit { font-family:var(â€“fm); font-size:7.5px; letter-spacing:.22em; color:var(â€“muted2); text-transform:lowercase; margin-top:2px; }
.start-btn-header {
flex-shrink:0; padding:16px 22px; border:none; border-radius:14px;
font-family:var(â€“fd); font-size:17px; font-weight:400; letter-spacing:.1em;
color:#1a1208; cursor:pointer; position:relative; overflow:hidden;
-webkit-appearance:none; transition:transform .15s, box-shadow .2s;
background:linear-gradient(135deg,#c8a26a 0%,#d4b47c 50%,#b89058 100%);
box-shadow:0 4px 22px rgba(200,162,106,.32), 0 2px 8px rgba(0,0,0,.38);
white-space:nowrap; min-width:90px; text-align:center; line-height:1.2;
}
.start-btn-header:active { transform:scale(.96); }
.start-btn-header::after { content:â€™â€™; position:absolute; inset:0; background:linear-gradient(180deg,rgba(255,255,255,.18) 0%,transparent 55%); pointer-events:none; }

.sec { padding:18px 24px 0; flex-shrink:0; }
.sec-lbl {
font-family:var(â€“fm); font-size:8.5px; letter-spacing:.35em; color:var(â€“muted2);
text-transform:uppercase; margin-bottom:12px; display:flex; align-items:center; gap:10px;
}
.sec-lbl::after { content:â€™â€™; flex:1; height:1px; background:var(â€“border); }

.pattern-grid { display:flex; flex-direction:column; gap:7px; }
.pattern-card {
background:var(â€“card); border:1px solid var(â€“border); border-radius:13px;
padding:12px 15px; cursor:pointer; display:flex; align-items:center; gap:13px;
transition:all .25s cubic-bezier(.4,0,.2,1);
}
.pattern-card:active { transform:scale(.985); }
.pattern-card.active { border-color:rgba(200,162,106,.7) !important; background:rgba(200,162,106,.14) !important; box-shadow:0 0 0 1px rgba(200,162,106,.3), inset 0 0 20px rgba(200,162,106,.05); }
.pattern-card.active[data-id=â€œdeepâ€] { border-color:rgba(122,158,126,.7) !important; background:rgba(122,158,126,.14) !important; box-shadow:0 0 0 1px rgba(122,158,126,.3), inset 0 0 20px rgba(122,158,126,.05); }
.pattern-card.active[data-id=â€œslowâ€] { border-color:rgba(176,122,138,.7) !important; background:rgba(176,122,138,.14) !important; box-shadow:0 0 0 1px rgba(176,122,138,.3), inset 0 0 20px rgba(176,122,138,.05); }
.pm { width:3px; height:34px; border-radius:2px; flex-shrink:0; background:var(â€“stone); transition:background .3s; }
.pattern-card.active[data-id=â€œboxâ€]  .pm { background:var(â€“amber); box-shadow:0 0 10px rgba(200,162,106,.5); }
.pattern-card.active[data-id=â€œdeepâ€] .pm { background:var(â€“sage);  box-shadow:0 0 10px rgba(122,158,126,.5); }
.pattern-card.active[data-id=â€œslowâ€] .pm { background:var(â€“rose);  box-shadow:0 0 10px rgba(176,122,138,.5); }
.pi { flex:1; }
.pn { font-size:16px; font-weight:400; color:var(â€“text); letter-spacing:.02em; }
.pd { font-family:var(â€“fm); font-size:9.5px; color:var(â€“muted); margin-top:3px; }
.ph-chip { font-family:var(â€“fm); font-size:9.5px; padding:3px 8px; border-radius:20px; background:var(â€“card); border:1px solid var(â€“border); color:var(â€“muted); flex-shrink:0; }

.dur-row { display:flex; gap:7px; }
.dur-pill {
flex:1; background:var(â€“card); border:1px solid var(â€“border);
border-radius:11px; padding:11px 4px; cursor:pointer; text-align:center; transition:all .2s;
}
.dur-pill:active { transform:scale(.95); }
.dur-pill.active { border-color:rgba(200,162,106,.5); background:rgba(200,162,106,.08); }
.dn { font-size:19px; font-weight:300; display:block; line-height:1; }
.dl { font-family:var(â€“fm); font-size:7.5px; color:var(â€“muted); letter-spacing:.1em; }

.track-list { display:flex; flex-direction:column; gap:7px; }
.track-card {
background:var(â€“card); border:1px solid var(â€“border); border-radius:13px;
padding:13px 15px; cursor:pointer; display:flex; align-items:center; gap:13px;
transition:all .25s cubic-bezier(.4,0,.2,1);
}
.track-card:active { transform:scale(.985); }
.track-card.active { border-color:rgba(200,162,106,.45); background:rgba(200,162,106,.07); }
.tk-icon { width:42px; height:42px; border-radius:10px; flex-shrink:0; font-size:18px; background:var(â€“card); border:1px solid var(â€“border); display:flex; align-items:center; justify-content:center; transition:all .3s; }
.track-card.active .tk-icon { background:rgba(200,162,106,.1); border-color:rgba(200,162,106,.3); }
.tk-info { flex:1; min-width:0; }
.tk-name { font-size:15px; font-weight:400; color:var(â€“text); }
.tk-desc { font-family:var(â€“fm); font-size:8.5px; color:var(â€“muted); margin-top:3px; letter-spacing:.03em; }
.tk-badge { font-family:var(â€“fm); font-size:8px; color:var(â€“muted2); letter-spacing:.06em; padding:2px 7px; border:1px solid var(â€“border); border-radius:8px; flex-shrink:0; }
.track-card.active .tk-badge { border-color:rgba(200,162,106,.3); color:var(â€“amber); }

.vol-wrap { display:flex; align-items:center; gap:12px; }
.vi { font-size:13px; color:var(â€“muted); }
input[type=range] { flex:1; -webkit-appearance:none; appearance:none; height:2px; background:var(â€“range-track); border-radius:2px; outline:none; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:var(â€“amber); cursor:pointer; box-shadow:0 0 10px rgba(200,162,106,.45); }

/* â”€â”€ PREVIEW BARS â”€â”€ */
.preview-box { display:flex; gap:8px; align-items:flex-end; padding:13px; border:1px solid var(â€“border); border-radius:14px; background:var(â€“card); height:80px; overflow:hidden; }
.prev-col { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; gap:5px; }
.prev-track { flex:1; width:100%; border-radius:3px; background:var(â€“bar-bg); border:1px solid var(â€“border); position:relative; overflow:hidden; }
.prev-fill { position:absolute; bottom:0; left:0; right:0; height:0%; border-radius:2px; transition:height .85s cubic-bezier(.4,0,.2,1); }
.prev-fill.fill-top { top:0; bottom:auto; border-radius:2px; transition:height .85s cubic-bezier(.4,0,.2,1); }
.prev-fill.fill-ltr { bottom:0; left:0; top:0; right:auto; height:100% !important; width:0%; border-radius:2px; transition:width .85s cubic-bezier(.4,0,.2,1); }
.prev-num { font-family:var(â€“fm); font-size:13px; font-weight:400; color:var(â€“muted); letter-spacing:.04em; flex-shrink:0; line-height:1; }
.prev-num.active-num { color:var(â€“text); }
.prev-name { font-family:var(â€“fm); font-size:7px; letter-spacing:.12em; color:var(â€“muted); text-transform:uppercase; flex-shrink:0; white-space:nowrap; }
.prev-count-row { display:flex; align-items:baseline; gap:2px; flex-shrink:0; }
.prev-sec-lbl { font-family:var(â€“fm); font-size:6px; letter-spacing:.1em; color:var(â€“muted2); text-transform:uppercase; }

.attr { font-family:var(â€“fm); font-size:8.5px; color:var(â€“muted2); letter-spacing:.1em; text-align:center; padding:9px 0 0; }

.start-btn {
width:100%; padding:19px; border:none; border-radius:15px;
font-family:var(â€“fd); font-size:19px; font-weight:400; letter-spacing:.18em;
color:#1a1208; cursor:pointer; position:relative; overflow:hidden;
-webkit-appearance:none; transition:transform .15s, box-shadow .2s;
background:linear-gradient(135deg,#c8a26a 0%,#d4b47c 45%,#b89058 100%);
box-shadow:0 6px 28px rgba(200,162,106,.28), 0 2px 8px rgba(0,0,0,.4);
}
.start-btn:active { transform:scale(.97); }
.start-btn::after { content:â€™â€™; position:absolute; inset:0; background:linear-gradient(180deg,rgba(255,255,255,.18) 0%,transparent 100%); pointer-events:none; }
.pwa-hint { text-align:center; font-family:var(â€“fm); font-size:8.5px; color:var(â€“muted2); letter-spacing:.12em; padding:11px 24px 0; flex-shrink:0; }

/* â”€â”€ SESSION â”€â”€ */
#session {
align-items:center; justify-content:space-between;
padding:max(env(safe-area-inset-top,0px),24px) 28px max(env(safe-area-inset-bottom,0px),24px);
overflow:hidden;
}
.orbs { position:fixed; top:0; left:0; right:0; bottom:0; inset:0; pointer-events:none; z-index:0; }
.orb { position:absolute; border-radius:50%; filter:blur(90px); transition:background 3s ease; }
.orb1 { width:420px; height:420px; top:-140px; right:-140px; opacity:.10; }
.orb2 { width:300px; height:300px; bottom:-90px; left:-110px; opacity:.07; }

.sess-hdr { display:flex; justify-content:space-between; align-items:flex-start; width:100%; z-index:1; flex-shrink:0; margin-bottom:10px; }
.close-btn { width:40px; height:40px; border-radius:50%; border:1px solid var(â€“border); background:var(â€“card); color:var(â€“muted); font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; -webkit-backdrop-filter:blur(10px); backdrop-filter:blur(10px); -webkit-appearance:none; }
.sess-meta { text-align:right; }
.spl { font-size:13px; font-weight:300; color:var(â€“text); letter-spacing:.04em; }
.shl { font-family:var(â€“fm); font-size:9px; color:var(â€“muted); letter-spacing:.12em; margin-top:3px; }

.ticker { font-family:var(â€“fm); font-size:9px; color:var(â€“muted); z-index:1; flex-shrink:0; display:flex; align-items:center; gap:8px; width:100%; margin-bottom:6px; }
.tdot { width:6px; height:6px; border-radius:50%; flex-shrink:0; background:var(â€“amber); animation:pdot 2.5s infinite; }
.ttxt { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
@keyframes pdot { 0%,100%{opacity:1;} 50%{opacity:.3;} }

.phase-info { z-index:1; flex-shrink:0; text-align:center; width:100%; margin-bottom:8px; }
.phase-lbl { font-family:var(â€“fm); font-size:clamp(14px,4vw,19px); letter-spacing:.44em; text-transform:uppercase; color:var(â€“muted); transition:color .6s ease; }
.countdown-row { display:flex; align-items:flex-end; justify-content:center; gap:8px; margin-top:4px; }
.countdown {
font-family:var(â€“fm);
font-size:clamp(110px,30vw,180px);
font-weight:400; line-height:1; letter-spacing:0;
font-variant-numeric:tabular-nums lining-nums;
-webkit-font-feature-settings:â€œtnumâ€ 1,â€œlnumâ€ 1;
font-feature-settings:â€œtnumâ€ 1,â€œlnumâ€ 1;
transition:color .6s ease;
display:inline-block;
}
.cunit { font-family:var(â€“fm); font-size:11px; letter-spacing:.35em; color:var(â€“muted); padding-bottom:12px; white-space:nowrap; }

.sess-pattern-desc {
z-index:1; flex-shrink:0; width:100%; margin-bottom:8px;
padding:13px 16px;
border:1px solid rgba(255,248,235,.07);
border-radius:14px;
background:linear-gradient(135deg, var(â€“card) 0%, rgba(200,162,106,.06) 100%);
position:relative; overflow:hidden;
}
.sess-pattern-desc::before {
content:â€™â€™; position:absolute; left:0; top:0; bottom:0; width:2px;
background:linear-gradient(180deg, var(â€“amber) 0%, transparent 100%); opacity:.5;
}
.sess-pattern-name { font-size:16px; font-weight:400; color:var(â€“text); letter-spacing:.04em; margin-bottom:5px; }
.sess-pattern-text { font-size:12px; font-weight:300; font-style:italic; color:var(â€“muted); line-height:1.6; }
.sess-pattern-steps { display:flex; gap:5px; margin-top:8px; flex-wrap:wrap; }
.sess-pattern-step { font-family:var(â€“fm); font-size:7.5px; padding:3px 8px; border-radius:20px; background:var(â€“bar-bg); border:1px solid var(â€“border); color:var(â€“muted2); letter-spacing:.07em; }

.breath-wrap { z-index:1; flex-shrink:0; width:100%; margin-bottom:12px; }
.breath-bars { display:flex; gap:9px; width:100%; height:clamp(60px,14vw,96px); }
.bar-col { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; gap:6px; }
.bar-track { flex:1; width:100%; position:relative; overflow:hidden; border-radius:5px 5px 4px 4px; background:var(â€“bar-bg); border:1px solid var(â€“border); transition:border-color .5s; }
.bar-track.cur { border-color:rgba(128,100,60,.22); }
.bar-fill { position:absolute; bottom:0; left:0; right:0; height:0%; border-radius:4px 4px 3px 3px; transition:height .95s cubic-bezier(.4,0,.2,1); }
.bar-fill.top-fill { top:0; bottom:auto; height:0%; }
.bar-fill.ltr-fill { top:0; bottom:0; left:0; right:auto; height:100%; width:0%; transition:width .95s cubic-bezier(.4,0,.2,1); }
.bar-fill::after { content:â€™â€™; position:absolute; top:-2px; left:0; right:0; height:12px; border-radius:50%; background:inherit; filter:blur(7px); opacity:0; transition:opacity .4s; }
.bar-track.cur .bar-fill::after { opacity:.7; }
.bar-lbl { font-family:var(â€“fm); font-size:7.5px; letter-spacing:.18em; text-transform:uppercase; color:var(â€“muted); transition:color .4s; flex-shrink:0; white-space:nowrap; }
.bar-col.cur .bar-lbl { color:var(â€“text); }

.sess-vol { display:flex; align-items:center; gap:12px; z-index:1; flex-shrink:0; width:100%; margin-bottom:10px; }
.prog-area { width:100%; z-index:1; flex-shrink:0; }
.prog-track { width:100%; height:2px; background:var(â€“prog-bg); border-radius:2px; overflow:hidden; margin-bottom:8px; }
.prog-fill { height:100%; border-radius:2px; width:0%; transition:width 1s linear; background:var(â€“amber); }
.prog-time { font-family:var(â€“fm); font-size:10px; color:var(â€“muted); letter-spacing:.1em; text-align:center; }

/* Debug */
.debug-toggle {
position:fixed; bottom:max(env(safe-area-inset-bottom,0px),14px); right:18px; z-index:1010;
font-family:var(â€“fm); font-size:8.5px; letter-spacing:.2em; color:var(â€“muted2);
background:var(â€“bg); border:1px solid rgba(255,255,255,.07); padding:5px 14px;
border-radius:20px; cursor:pointer; -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px);
-webkit-appearance:none; transition:all .2s;
}
.debug-toggle:active { opacity:.6; }
.debug-toggle.has-error { color:#e07a7a; border-color:rgba(224,122,122,.25); }

/* FIXED: Debug panel â€” full viewport coverage with explicit top/left/right/bottom for Safari */
.debug-panel {
position:fixed;
top:0; left:0; right:0; bottom:0;
width:100%; height:100%;
z-index:1000;
background:var(â€“bg);
display:flex; flex-direction:column;
padding:max(env(safe-area-inset-top,0px),20px) 0 max(env(safe-area-inset-bottom,0px),20px);
transition:opacity .25s, transform .25s cubic-bezier(.4,0,.2,1);
overflow:hidden;
}
.debug-panel.hidden { opacity:0; pointer-events:none; transform:translateY(16px); }
.debug-hdr { display:flex; justify-content:space-between; align-items:center; padding:0 20px 16px; border-bottom:1px solid rgba(255,255,255,.06); flex-shrink:0; }
.debug-title { font-family:var(â€“fm); font-size:10px; letter-spacing:.3em; color:var(â€“muted2); text-transform:uppercase; }
.debug-close { font-family:var(â€“fm); font-size:10px; color:var(â€“muted); cursor:pointer; padding:4px 10px; border:1px solid var(â€“border); border-radius:8px; background:transparent; -webkit-appearance:none; }
.debug-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:14px 20px; }
.debug-section { margin-bottom:16px; }
.debug-section-title { font-family:var(â€“fm); font-size:8px; letter-spacing:.3em; color:var(â€“muted2); text-transform:uppercase; margin-bottom:8px; }
.debug-row { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid rgba(255,255,255,.04); }
.debug-key { font-family:var(â€“fm); font-size:9.5px; color:var(â€“muted); }
.debug-val { font-family:var(â€“fm); font-size:9.5px; color:var(â€“text); word-break:break-all; text-align:right; max-width:65%; }
.debug-val.ok  { color:#7a9e7e; }
.debug-val.err { color:#e07a7a; }
.debug-val.warn{ color:#c8a26a; }
.debug-log { background:var(â€“bar-bg); border:1px solid var(â€“border); border-radius:10px; padding:12px; font-family:var(â€“fm); font-size:9px; color:var(â€“muted); line-height:1.8; white-space:pre-wrap; word-break:break-all; max-height:180px; overflow-y:auto; -webkit-overflow-scrolling:touch; }
.debug-actions { padding:12px 20px 0; flex-shrink:0; display:flex; gap:8px; }
.debug-btn { flex:1; padding:10px; font-family:var(â€“fm); font-size:9px; letter-spacing:.15em; text-transform:uppercase; color:var(â€“muted); border:1px solid var(â€“border); border-radius:10px; background:var(â€“bar-bg); cursor:pointer; -webkit-appearance:none; }
.debug-btn.primary { color:var(â€“amber); border-color:rgba(200,162,106,.3); }

/* â”€â”€ END â”€â”€ */
#end { align-items:center; justify-content:center; text-align:center; gap:26px; padding:40px 32px max(env(safe-area-inset-bottom,0px),32px); }
.end-mark { font-size:52px; color:var(â€“amber); text-shadow:0 0 40px rgba(200,162,106,.45); }
.end-title { font-size:38px; font-weight:300; letter-spacing:.06em; line-height:1.15; }
.end-div { width:38px; height:1px; background:var(â€“gold-ln); }
.end-sub { font-size:14px; font-weight:300; color:var(â€“muted); line-height:1.75; max-width:260px; font-style:italic; }
.end-stats { display:flex; gap:28px; padding:20px 32px; border:1px solid var(â€“border); border-radius:17px; background:var(â€“card); }
.stat { display:flex; flex-direction:column; align-items:center; gap:4px; }
.stat-val { font-size:26px; font-weight:300; color:var(â€“amber); font-family:var(â€“fm); }
.stat-lbl { font-family:var(â€“fm); font-size:8px; letter-spacing:.25em; color:var(â€“muted); text-transform:uppercase; }
.again-btn { width:100%; padding:16px; border:1px solid var(â€“border); border-radius:13px; background:var(â€“card); color:var(â€“text); font-family:var(â€“fd); font-size:16px; font-weight:300; letter-spacing:.12em; cursor:pointer; -webkit-appearance:none; transition:background .2s, border-color .2s; }
.again-btn:active { background:rgba(200,162,106,.08); border-color:rgba(200,162,106,.3); }

/* â”€â”€ FREQUENZE SOLFEGGIO â”€â”€ */
.freq-grid { display:grid; grid-template-columns:1fr 1fr; gap:7px; }
.freq-card { background:var(â€“card); border:1px solid var(â€“border); border-radius:12px; padding:11px 13px; cursor:pointer; transition:all .22s cubic-bezier(.4,0,.2,1); }
.freq-card:active { transform:scale(.97); }
.freq-card.active { border-color:rgba(200,162,106,.5); background:rgba(200,162,106,.08); }
.fq-hz { font-family:var(â€“fm); font-size:11.5px; letter-spacing:.05em; color:var(â€“amber); margin-bottom:3px; transition:color .3s; }
.freq-card:not(.active) .fq-hz { color:var(â€“muted); }
.fq-name { font-size:14px; font-weight:400; color:var(â€“text); letter-spacing:.02em; line-height:1.2; }
.fq-desc { font-family:var(â€“fm); font-size:7.5px; color:var(â€“muted); margin-top:3px; letter-spacing:.03em; line-height:1.5; }

/* â”€â”€ SAVE BUTTON â”€â”€ */
.save-btn {
width:100%; padding:13px; border:1px solid rgba(200,162,106,.22); border-radius:12px;
background:rgba(200,162,106,.05); color:var(â€“amber);
font-family:var(â€“fm); font-size:9px; letter-spacing:.28em; text-transform:uppercase;
cursor:pointer; -webkit-appearance:none; transition:all .2s;
display:flex; align-items:center; justify-content:center; gap:8px;
}
.save-btn:active { background:rgba(200,162,106,.12); transform:scale(.98); }
.save-btn.saved { border-color:rgba(122,158,126,.35); color:var(â€“sage); background:rgba(122,158,126,.06); }
.save-icon { font-size:12px; }

@media (max-height:800px) {
.countdown { font-size:clamp(90px,26vw,140px); }
.breath-bars { height:58px; }
}
@media (max-height:700px) {
.app-header { padding:14px 24px 18px; }
.countdown { font-size:clamp(76px,22vw,116px); }
.breath-bars { height:50px; }
.sec { padding:12px 24px 0; }
}
@media (max-height:620px) {
.countdown { font-size:72px; }
.breath-bars { height:42px; }
}

/* â”€â”€ THEME TOGGLE â”€â”€ */
.theme-toggle {
width:44px; height:26px; border-radius:13px; border:1.5px solid var(â€“border);
background:var(â€“card); cursor:pointer; -webkit-appearance:none; appearance:none;
transition:background .35s, border-color .35s;
display:flex; align-items:center; padding:0 3px; flex-shrink:0;
}
.theme-toggle-knob {
width:18px; height:18px; border-radius:50%;
background:var(â€“amber);
transition:transform .35s cubic-bezier(.4,0,.2,1), background .35s;
flex-shrink:0; position:relative;
display:flex; align-items:center; justify-content:center;
font-size:9px; line-height:1;
}
:root.light .theme-toggle-knob { transform:translateX(18px); }
.theme-toggle-icon { pointer-events:none; }

:root.light .orb1 { opacity:.07; }
:root.light .orb2 { opacity:.05; }
:root.light .pattern-card.active { box-shadow:0 0 0 1px rgba(154,108,50,.4), inset 0 0 20px rgba(154,108,50,.06); }
:root.light .pattern-card.active[data-id=â€œdeepâ€] { box-shadow:0 0 0 1px rgba(74,122,80,.4), inset 0 0 20px rgba(74,122,80,.06); }
:root.light .pattern-card.active[data-id=â€œslowâ€] { box-shadow:0 0 0 1px rgba(136,64,96,.4), inset 0 0 20px rgba(136,64,96,.06); }
:root.light body { background:var(â€“bg); }
:root.light .bar-track.cur { border-color:rgba(60,40,10,.18); }
:root.light .debug-row { border-bottom:1px solid rgba(0,0,0,.06); }
:root.light .debug-hdr { border-bottom:1px solid rgba(0,0,0,.06); }
:root.light .debug-panel { border-top:none; }
:root.light .prog-track { background:rgba(0,0,0,.08); }

/* â”€â”€ GEAR BUTTON â”€â”€ */
.gear-btn {
width:36px; height:36px; border-radius:50%; border:1px solid var(â€“border);
background:var(â€“card); color:var(â€“muted); font-size:16px;
cursor:pointer; display:flex; align-items:center; justify-content:center;
-webkit-appearance:none; transition:all .2s; flex-shrink:0;
-webkit-backdrop-filter:blur(10px); backdrop-filter:blur(10px);
}
.gear-btn:active { transform:rotate(45deg) scale(.92); }

/* FIXED: Settings panel â€” full viewport coverage with explicit fallbacks for Safari */
.settings-panel {
position:fixed;
top:0; left:0; right:0; bottom:0;
width:100%; height:100%;
z-index:1000;
display:flex; flex-direction:column;
background:var(â€“bg);
padding:max(env(safe-area-inset-top,0px),20px) 0 max(env(safe-area-inset-bottom,0px),24px);
transition:opacity .3s cubic-bezier(.4,0,.2,1), transform .3s cubic-bezier(.4,0,.2,1);
overflow:hidden;
}
.settings-panel.hidden { opacity:0; pointer-events:none; transform:translateY(20px); }

.settings-hdr {
display:flex; justify-content:space-between; align-items:center;
padding:0 24px 18px; border-bottom:1px solid var(â€“border); flex-shrink:0;
}
.settings-title { font-family:var(â€“fm); font-size:10px; letter-spacing:.4em; color:var(â€“muted2); text-transform:uppercase; }
.settings-close { font-family:var(â€“fm); font-size:10px; color:var(â€“muted); cursor:pointer; padding:5px 12px; border:1px solid var(â€“border); border-radius:8px; background:var(â€“card); -webkit-appearance:none; }

.settings-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:20px 24px; }
.settings-section { margin-bottom:28px; }
.settings-section-title {
font-family:var(â€“fm); font-size:8px; letter-spacing:.38em;
color:var(â€“muted2); text-transform:uppercase; margin-bottom:14px;
display:flex; align-items:center; gap:10px;
}
.settings-section-title::after { content:â€™â€™; flex:1; height:1px; background:var(â€“border); }

/* Toggle row */
.toggle-row {
display:flex; justify-content:space-between; align-items:center;
padding:14px 0; border-bottom:1px solid var(â€“border);
}
.toggle-row:last-child { border-bottom:none; }
.toggle-info { flex:1; min-width:0; padding-right:16px; }
.toggle-label { font-size:15px; font-weight:400; color:var(â€“text); letter-spacing:.02em; }
.toggle-desc { font-family:var(â€“fm); font-size:8.5px; color:var(â€“muted); margin-top:3px; letter-spacing:.03em; line-height:1.5; }

/* FIXED: iOS-style toggle switch â€” explicit colors, no var() fallback issues */
.sw {
width:48px; height:28px; border-radius:14px; flex-shrink:0;
background:rgba(120,120,128,0.32); /* iOS-style off color â€” explicit, no var() */
position:relative; cursor:pointer;
transition:background .25s;
-webkit-appearance:none; border:none; outline:none;
/* FIXED: ensure the button is always visually present */
display:block;
min-width:48px;
}
.sw::after {
content:â€™â€™; position:absolute; top:3px; left:3px;
width:22px; height:22px; border-radius:11px; background:#ffffff;
transition:transform .25s cubic-bezier(.4,0,.2,1);
box-shadow:0 1px 4px rgba(0,0,0,.35);
}
.sw.on { background:var(â€“amber); }
/* Explicit fallback in case var(â€“amber) fails */
.sw.on:not(:root.light .sw.on) { background:#c8a26a; }
.sw.on::after { transform:translateX(20px); }
.sw.sage.on { background:var(â€“sage); }

/* Nota tecnica audio */
.audio-note { background:var(â€“card); border:1px solid var(â€“border); border-radius:12px; padding:13px 15px; margin-top:12px; }
.audio-note-title { font-family:var(â€“fm); font-size:8px; letter-spacing:.3em; color:var(â€“amber); margin-bottom:6px; }
.audio-note-text { font-family:var(â€“fm); font-size:8.5px; color:var(â€“muted); line-height:1.7; }

/* â”€â”€ TRACCIA PERSONALIZZATA â”€â”€ */
.custom-track-area {
margin-top:14px;
border:1px solid var(â€“border);
border-radius:14px;
overflow:hidden;
transition:opacity .3s, border-color .3s;
}
.custom-track-area.disabled { opacity:.38; pointer-events:none; }

#customFileInput { position:absolute; width:1px; height:1px; opacity:0; pointer-events:none; }

.ct-empty { padding:16px; display:flex; flex-direction:column; gap:12px; background:var(â€“card); border-radius:14px; }

.ct-pick-btn {
display:flex; align-items:center; gap:12px;
padding:14px 16px; border-radius:11px;
border:1.5px solid var(â€“border);
background:rgba(255,255,255,.07);
cursor:pointer; transition:all .2s;
-webkit-tap-highlight-color:transparent;
text-decoration:none;
}
.ct-pick-btn:active { background:rgba(200,162,106,.08); border-color:rgba(200,162,106,.5); transform:scale(.98); }
.ct-pick-icon { font-size:22px; flex-shrink:0; }
.ct-pick-main { font-family:var(â€“fd); font-size:15px; font-weight:400; color:var(â€“text); letter-spacing:.02em; line-height:1.2; }
.ct-pick-sub { font-family:var(â€“fm); font-size:8px; letter-spacing:.15em; color:var(â€“muted); text-transform:uppercase; display:block; margin-top:2px; }

.ct-or { display:flex; align-items:center; gap:10px; font-family:var(â€“fm); font-size:8px; letter-spacing:.25em; color:var(â€“muted2); text-transform:uppercase; }
.ct-or::before,.ct-or::after { content:â€™â€™; flex:1; height:1px; background:var(â€“border); }

/* FIXED: URL input row â€” explicit sizing and visible styling */
.ct-url-row { display:flex; gap:8px; align-items:stretch; }
.ct-url-input {
flex:1; min-width:0;
font-family:var(â€“fm); font-size:11px; letter-spacing:.02em;
color:var(â€“text);
background:#1a1810;
border:1.5px solid #3a3428;
border-radius:10px;
padding:11px 12px; outline:none;
-webkit-appearance:none; transition:border-color .2s, background .2s;
/* FIXED: ensure input is always visible */
display:block;
width:100%;
min-height:44px;
}
:root.light .ct-url-input { background:#ede7d8; border-color:#c8b898; }
.ct-url-input:focus { border-color:rgba(200,162,106,.8); background:#201e16; }
:root.light .ct-url-input:focus { background:#e8e0ce; border-color:rgba(154,108,50,.8); }
.ct-url-input::placeholder { color:rgba(240,235,226,0.35); font-size:9.5px; letter-spacing:.04em; }
:root.light .ct-url-input::placeholder { color:rgba(30,26,20,0.4); }

.ct-url-btn {
flex-shrink:0; padding:0 14px; border-radius:10px;
border:1.5px solid rgba(200,162,106,.5);
background:rgba(200,162,106,.12); color:var(â€“amber);
font-family:var(â€“fm); font-size:9px; letter-spacing:.18em; text-transform:uppercase;
cursor:pointer; -webkit-appearance:none; transition:all .2s; white-space:nowrap;
min-height:44px;
}
.ct-url-btn:active { background:rgba(200,162,106,.25); transform:scale(.97); }
.ct-url-btn:disabled { opacity:.4; }
.ct-url-hint { font-family:var(â€“fm); font-size:8px; color:var(â€“muted); letter-spacing:.08em; text-align:center; padding-bottom:2px; }

.ct-loaded { background:var(â€“card); }
.ct-file-row { display:flex; align-items:center; gap:10px; padding:14px 14px 0; }
.ct-file-icon { font-size:20px; flex-shrink:0; }
.ct-file-info { flex:1; min-width:0; }
.ct-file-name { font-family:var(â€“fm); font-size:10px; color:var(â€“sage); letter-spacing:.04em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ct-file-meta { font-family:var(â€“fm); font-size:8px; color:var(â€“muted2); letter-spacing:.1em; margin-top:2px; }
.ct-change-btn { flex-shrink:0; padding:6px 12px; border-radius:8px; border:1px solid var(â€“border); background:var(â€“bar-bg); color:var(â€“muted); font-family:var(â€“fm); font-size:8px; letter-spacing:.18em; text-transform:uppercase; cursor:pointer; -webkit-appearance:none; transition:all .2s; }
.ct-change-btn:active { border-color:rgba(200,162,106,.4); color:var(â€“amber); }

.custom-controls { display:flex; align-items:center; gap:10px; padding:12px 14px; border-top:1px solid var(â€“border); margin-top:12px; }
.custom-play-btn { width:36px; height:36px; border-radius:50%; flex-shrink:0; border:1px solid var(â€“border); background:var(â€“card); color:var(â€“text); font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; -webkit-appearance:none; transition:all .2s; }
.custom-play-btn:active { transform:scale(.92); }
.custom-play-btn.playing { border-color:rgba(122,158,126,.5); color:var(â€“sage); }
.custom-waveform { flex:1; height:28px; border-radius:6px; background:var(â€“bar-bg); border:1px solid var(â€“border); position:relative; overflow:hidden; }
.custom-progress { position:absolute; top:0; left:0; bottom:0; width:0%; background:linear-gradient(90deg,rgba(122,158,126,.4) 0%,rgba(122,158,126,.15) 100%); transition:width .5s linear; }
.custom-time { font-family:var(â€“fm); font-size:9px; color:var(â€“muted); letter-spacing:.08em; flex-shrink:0; min-width:38px; text-align:right; }
.custom-remove { width:28px; height:28px; border-radius:50%; flex-shrink:0; border:1px solid var(â€“border); background:transparent; color:var(â€“muted); font-size:11px; cursor:pointer; display:flex; align-items:center; justify-content:center; -webkit-appearance:none; transition:all .2s; }
.custom-remove:active { color:var(â€“rose); border-color:var(â€“rose); }

</style>
</head>
<body>

<!-- â•â•â• SETUP â•â•â• -->

<div class="screen" id="setup">
  <div class="app-header">
    <div class="app-title-wrap">
      <h1 class="app-title">Respira</h1>
      <p class="app-sub">respirazione assistita</p>
      <p class="app-credit">by ninGia zuleziM</p>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
      <button class="gear-btn" id="gearBtn" aria-label="Impostazioni">âš™</button>
      <button class="start-btn-header" id="startBtn">Inizia<br>â€º</button>
    </div>
  </div>

  <div class="sec" style="padding-top:16px;padding-bottom:0">
    <button class="save-btn" id="saveBtn"><span class="save-icon">â†“</span> Salva impostazioni</button>
  </div>

  <div class="sec">
    <div class="sec-lbl">01 â€” Tecnica di respirazione</div>
    <div class="pattern-grid">
      <div class="pattern-card active" data-id="box">
        <div class="pm"></div>
        <div class="pi"><div class="pn">Box Breathing</div><div class="pd">Riduce stress acuto Â· stimola concentrazione</div></div>
        <span class="ph-chip">4Â·4Â·4Â·4</span>
      </div>
      <div class="pattern-card" data-id="deep">
        <div class="pm"></div>
        <div class="pi"><div class="pn">Coerenza Cardiaca</div><div class="pd">Equilibrio sistema nervoso Â· 5 respiri/min</div></div>
        <span class="ph-chip">5Â·5</span>
      </div>
      <div class="pattern-card" data-id="slow">
        <div class="pm"></div>
        <div class="pi"><div class="pn">Respirazione Lenta</div><div class="pd">Massimo rilassamento Â· attivazione vagale</div></div>
        <span class="ph-chip">6Â·6</span>
      </div>
    </div>
    <div class="preview-box" id="previewBars" style="margin-top:10px;"></div>
  </div>

  <div class="sec">
    <div class="sec-lbl">02 â€” Durata sessione</div>
    <div class="dur-row">
      <div class="dur-pill active" data-min="3"><span class="dn">3</span><span class="dl">min</span></div>
      <div class="dur-pill" data-min="5"><span class="dn">5</span><span class="dl">min</span></div>
      <div class="dur-pill" data-min="7"><span class="dn">7</span><span class="dl">min</span></div>
      <div class="dur-pill" data-min="10"><span class="dn">10</span><span class="dl">min</span></div>
      <div class="dur-pill" data-min="15"><span class="dn">15</span><span class="dl">min</span></div>
      <div class="dur-pill" data-min="20"><span class="dn">20</span><span class="dl">min</span></div>
    </div>
  </div>

  <div class="sec">
    <div class="sec-lbl">03 â€” Atmosfera sonora</div>
    <div class="track-list">
      <div class="track-card active" data-tid="cosmos">
        <div class="tk-icon">ğŸŒŒ</div>
        <div class="tk-info"><div class="tk-name">Cosmo</div><div class="tk-desc">Drone siderale Â· sine puri Â· spazio infinito</div></div>
        <span class="tk-badge">sintetica</span>
      </div>
      <div class="track-card" data-tid="forest">
        <div class="tk-icon">ğŸŒ¿</div>
        <div class="tk-info"><div class="tk-name">Foresta</div><div class="tk-desc">Pad organici Â· archi profondi Â· calore terroso</div></div>
        <span class="tk-badge">sintetica</span>
      </div>
      <div class="track-card" data-tid="ocean">
        <div class="tk-icon">ğŸŒŠ</div>
        <div class="tk-info"><div class="tk-name">Oceano</div><div class="tk-desc">Onde modulate Â· rumore filtrato Â· profonditÃ </div></div>
        <span class="tk-badge">sintetica</span>
      </div>
      <div class="track-card" data-tid="temple">
        <div class="tk-icon">ğŸ””</div>
        <div class="tk-info"><div class="tk-name">Tempio</div><div class="tk-desc">Campane tibetane Â· risonanza del silenzio</div></div>
        <span class="tk-badge">sintetica</span>
      </div>
    </div>
    <div class="attr">â— Audio generato in tempo reale Â· offline Â· zero download</div>
  </div>

  <div class="sec">
    <div class="sec-lbl">04 â€” Frequenza di risonanza</div>
    <div class="freq-grid" id="freqGrid">
      <div class="freq-card active" data-fid="none"><div class="fq-hz">â€”</div><div class="fq-name">Nessuna</div><div class="fq-desc">Solo atmosfera</div></div>
      <div class="freq-card" data-fid="f396"><div class="fq-hz">396 Hz</div><div class="fq-name">Liberazione</div><div class="fq-desc">Scioglie paura e senso di colpa</div></div>
      <div class="freq-card" data-fid="f417"><div class="fq-hz">417 Hz</div><div class="fq-name">Cambiamento</div><div class="fq-desc">Facilita la trasformazione</div></div>
      <div class="freq-card" data-fid="f432"><div class="fq-hz">432 Hz</div><div class="fq-name">Armonia</div><div class="fq-desc">Accordatura naturale Â· terra</div></div>
      <div class="freq-card" data-fid="f528"><div class="fq-hz">528 Hz</div><div class="fq-name">Guarigione</div><div class="fq-desc">Frequenza del DNA Â· amore</div></div>
      <div class="freq-card" data-fid="f639"><div class="fq-hz">639 Hz</div><div class="fq-name">Connessione</div><div class="fq-desc">Relazioni Â· armonia sociale</div></div>
      <div class="freq-card" data-fid="f741"><div class="fq-hz">741 Hz</div><div class="fq-name">Chiarezza</div><div class="fq-desc">Intuizione Â· espressione</div></div>
      <div class="freq-card" data-fid="f852"><div class="fq-hz">852 Hz</div><div class="fq-name">Risveglio</div><div class="fq-desc">Intuizione spirituale Â· terzo occhio</div></div>
    </div>
  </div>

  <div class="sec" style="padding-bottom:0">
    <div class="sec-lbl">05 â€” Volume</div>
    <div class="vol-wrap">
      <span class="vi">ğŸ”ˆ</span>
      <input type="range" id="volSetup" min="0" max="1" step="0.05" value="0.6">
      <span class="vi">ğŸ”Š</span>
    </div>
  </div>

  <p class="pwa-hint">Safari â†’ Condividi â†’ Aggiungi a schermata Home</p>
</div>

<!-- â•â•â• SESSION â•â•â• -->

<div class="screen hidden" id="session">
  <div class="orbs">
    <div class="orb orb1" id="orb1"></div>
    <div class="orb orb2" id="orb2"></div>
  </div>
  <div class="sess-hdr">
    <div style="display:flex;align-items:center;gap:8px;">
      <button class="close-btn" id="closeBtn">âœ•</button>
      <button class="gear-btn" id="gearBtnSession" aria-label="Impostazioni" style="opacity:.8;">âš™</button>
    </div>
    <div class="sess-meta">
      <div class="spl" id="sessPatLabel">Box 4-4-4-4</div>
      <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end;margin-top:3px;">
        <span class="sess-sound-icon" id="sessSoundIcon" style="font-size:22px;line-height:1;">ğŸŒŒ</span>
        <span class="shl" id="sessTrackLabel">Cosmo</span>
      </div>
    </div>
  </div>
  <div class="ticker">
    <span class="tdot" id="tickerDot"></span>
    <span class="ttxt" id="tickerText">Avvio sintesi audioâ€¦</span>
  </div>
  <div class="phase-info">
    <div class="phase-lbl" id="phaseLbl">â€”</div>
    <div class="countdown-row">
      <div class="countdown" id="countNum">1</div>
      <div class="cunit">sec</div>
    </div>
  </div>
  <div class="breath-wrap">
    <div class="breath-bars" id="breathBars"></div>
  </div>
  <div class="sess-pattern-desc" id="sessPatternDesc">
    <div class="sess-pattern-name" id="sessPatternName">â€”</div>
    <div class="sess-pattern-text" id="sessPatternText">â€”</div>
    <div class="sess-pattern-steps" id="sessPatternSteps"></div>
  </div>
  <div class="sess-vol">
    <span class="vi">ğŸ”ˆ</span>
    <input type="range" id="sessVol" min="0" max="1" step="0.05" value="0.6">
    <span class="vi">ğŸ”Š</span>
  </div>
  <div class="prog-area">
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-time" id="progTime">â€”</div>
  </div>
</div>

<!-- â•â•â• END â•â•â• -->

<div class="screen hidden" id="end">
  <div class="end-mark">â—</div>
  <div><h2 class="end-title">Sessione<br>completata</h2></div>
  <div class="end-div"></div>
  <p class="end-sub">Prenditi un momento prima di rientrare nel mondo.<br>Il tuo sistema nervoso ti ringrazia.</p>
  <div class="end-stats">
    <div class="stat"><span class="stat-val" id="statMin">5</span><span class="stat-lbl">minuti</span></div>
    <div class="stat"><span class="stat-val" id="statCycles">â€”</span><span class="stat-lbl">cicli</span></div>
    <div class="stat"><span class="stat-val" id="statTrack">â€”</span><span class="stat-lbl">brano</span></div>
  </div>
  <button class="again-btn" id="againBtn">Nuova sessione</button>
</div>

<!-- â•â•â• SETTINGS PANEL â•â•â• -->

<div class="settings-panel hidden" id="settingsPanel">
  <div class="settings-hdr">
    <span class="settings-title">âš™ Impostazioni</span>
    <button class="settings-close" id="settingsClose">Chiudi</button>
  </div>
  <div class="settings-scroll">

```
<div class="settings-section">
  <div class="settings-section-title">Audio</div>
  <div class="toggle-row">
    <div class="toggle-info">
      <div class="toggle-label">ModalitÃ  Cuffie</div>
      <div class="toggle-desc">Ottimizza le frequenze per cuffie e auricolari.<br>Disabilita se usi gli altoparlanti del telefono.</div>
    </div>
    <button class="sw on" id="swHeadphones" role="switch" aria-checked="true"></button>
  </div>
  <div class="toggle-row">
    <div class="toggle-info">
      <div class="toggle-label">Limiter Master</div>
      <div class="toggle-desc">Riduce la distorsione sugli altoparlanti.<br>Comprime i picchi audio prima dell'uscita.</div>
    </div>
    <button class="sw on sage" id="swLimiter" role="switch" aria-checked="true"></button>
  </div>
  <div class="audio-note">
    <div class="audio-note-title">PERCHÃ‰ SI SENTE DISTORSIONE</div>
    <div class="audio-note-text">
      Gli oscillatori sinusoidali sommati creano picchi di ampiezza (clipping). 
      Gli altoparlanti piccoli degli smartphone distorcono giÃ  a volumi medi, 
      specialmente sotto i 100 Hz. Con le cuffie questo Ã¨ quasi impercettibile.<br><br>
      <strong style="color:var(--text)">Soluzione:</strong> il Limiter Master comprime 
      i picchi Â· la ModalitÃ  Altoparlante taglia le sub-basse sotto 120 Hz e applica 
      un high-pass filter che riduce la fatica della membrana.
    </div>
  </div>
</div>

<div class="settings-section">
  <div class="settings-section-title">Tema</div>
  <div class="toggle-row">
    <div class="toggle-info">
      <div class="toggle-label">Tema Chiaro</div>
      <div class="toggle-desc">Passa dalla modalitÃ  scura a quella chiara.</div>
    </div>
    <button class="sw" id="swTheme" role="switch" aria-checked="false"></button>
  </div>
</div>

<div class="settings-section">
  <div class="settings-section-title">Traccia Personale</div>
  <div class="toggle-row">
    <div class="toggle-info">
      <div class="toggle-label">Usa traccia personale</div>
      <div class="toggle-desc">Sostituisce atmosfera sonora e frequenza con il tuo audio. Formati supportati: MP3, AAC, WAV, OGG.</div>
    </div>
    <button class="sw" id="swCustomTrack" role="switch" aria-checked="false"></button>
  </div>

  <div class="custom-track-area disabled" id="customTrackArea">
    <!-- Stato: nessun file caricato -->
    <div class="ct-empty" id="ctEmpty">
      <label class="ct-pick-btn" for="customFileInput">
        <span class="ct-pick-icon">ğŸ“‚</span>
        <div>
          <div class="ct-pick-main">Scegli dal dispositivo</div>
          <span class="ct-pick-sub">MP3 Â· AAC Â· WAV Â· OGG Â· FLAC</span>
        </div>
      </label>
      <input type="file" id="customFileInput" accept="audio/*,audio/flac,.mp3,.aac,.wav,.ogg,.flac,.m4a,.opus">
      <div class="ct-or"><span>oppure</span></div>
      <div class="ct-url-row">
        <input type="url" id="customUrlInput" class="ct-url-input"
          placeholder="https://â€¦ (link diretto a file audio)"
          autocomplete="off" autocorrect="off" spellcheck="false">
        <button class="ct-url-btn" id="customUrlBtn">Carica</button>
      </div>
      <div class="ct-url-hint">Incolla l'URL diretto di un file audio online</div>
    </div>

    <!-- Stato: file caricato -->
    <div class="ct-loaded" id="ctLoaded" style="display:none">
      <div class="ct-file-row">
        <span class="ct-file-icon">ğŸµ</span>
        <div class="ct-file-info">
          <div class="ct-file-name" id="ctFileName">â€”</div>
          <div class="ct-file-meta" id="ctFileMeta">â€”</div>
        </div>
        <button class="ct-change-btn" id="ctChangeBtn">Cambia</button>
      </div>
      <div class="custom-controls" id="customControls">
        <button class="custom-play-btn" id="customPlayBtn">â–¶</button>
        <div class="custom-waveform">
          <div class="custom-progress" id="customProgress"></div>
        </div>
        <span class="custom-time" id="customTime">0:00</span>
        <button class="custom-remove" id="customRemove" title="Rimuovi">âœ•</button>
      </div>
    </div>
  </div>
</div>
```

  </div>
</div>

<!-- â•â•â• DEBUG â•â•â• -->

<button class="debug-toggle hidden" id="debugToggle">â—‰ debug</button>

<div class="debug-panel hidden" id="debugPanel">
  <div class="debug-hdr">
    <span class="debug-title">â—‰ Debug</span>
    <button class="debug-close" id="debugClose">Chiudi</button>
  </div>
  <div class="debug-scroll">
    <div class="debug-section">
      <div class="debug-section-title">Dispositivo</div>
      <div class="debug-row"><span class="debug-key">User Agent</span><span class="debug-val" id="dbUA">â€”</span></div>
      <div class="debug-row"><span class="debug-key">Safari / iOS</span><span class="debug-val" id="dbSafari">â€”</span></div>
      <div class="debug-row"><span class="debug-key">Risoluzione</span><span class="debug-val" id="dbRes">â€”</span></div>
    </div>
    <div class="debug-section">
      <div class="debug-section-title">Audio Engine</div>
      <div class="debug-row"><span class="debug-key">AudioContext</span><span class="debug-val" id="dbAC">â€”</span></div>
      <div class="debug-row"><span class="debug-key">Sintesi attiva</span><span class="debug-val" id="dbSynth">â€”</span></div>
      <div class="debug-row"><span class="debug-key">Atmosfera</span><span class="debug-val" id="dbTrack">â€”</span></div>
      <div class="debug-row"><span class="debug-key">Nodi audio</span><span class="debug-val" id="dbNodes">â€”</span></div>
    </div>
    <div class="debug-section">
      <div class="debug-section-title">Log eventi</div>
      <div class="debug-log" id="dbLog">â€”</div>
    </div>
  </div>
  <div class="debug-actions">
    <button class="debug-btn primary" id="dbCopy">Copia log</button>
    <button class="debug-btn" id="dbCloseBtn">Chiudi</button>
  </div>
</div>

<script>
'use strict';

var PATTERNS = {
  box:  {
    name:'Box 4-4-4-4', color:'#c8a26a',
    phases:[{n:'Inspira',d:4},{n:'Trattieni',d:4},{n:'Espira',d:4},{n:'Pausa',d:4}],
    desc:'Inspira, trattieni, espira e pausa â€” ognuna 4 secondi. Attiva il sistema parasimpatico, riduce il cortisolo e riporta l\'attenzione al momento presente.',
    steps:['Inspira 4s','Trattieni 4s','Espira 4s','Pausa 4s']
  },
  deep: {
    name:'Coerenza Cardiaca', color:'#7a9e7e',
    phases:[{n:'Inspira',d:5},{n:'Espira',d:5}],
    desc:'5 respiri al minuto per 5 minuti: sincronizza la variabilitÃ  cardiaca, bilancia il sistema nervoso autonomo e abbassa la pressione sanguigna.',
    steps:['Inspira 5s','Espira 5s']
  },
  slow: {
    name:'Respirazione Lenta', color:'#b07a8a',
    phases:[{n:'Inspira',d:6},{n:'Espira',d:6}],
    desc:'Respiro a 5 atti al minuto con espiro prolungato. Massima attivazione vagale, riduzione dell\'ansia e promozione del sonno profondo.',
    steps:['Inspira 6s','Espira 6s']
  }
};
var PC = { Inspira:'#c8a26a', Trattieni:'#7a9e7e', Espira:'#b07a8a', Pausa:'#9a8a78' };
var TRACKS = {
  cosmos: { name:'Cosmo',   color:'#7a8ea0', icon:'ğŸŒŒ' },
  forest: { name:'Foresta', color:'#7a9e7a', icon:'ğŸŒ¿' },
  ocean:  { name:'Oceano',  color:'#6a8a9e', icon:'ğŸŒŠ' },
  temple: { name:'Tempio',  color:'#9a8a7a', icon:'ğŸ””' }
};
var FREQS = {
  none: { hz:0,   name:'Nessuna' },
  f396: { hz:396, name:'396 Hz Â· Liberazione' },
  f417: { hz:417, name:'417 Hz Â· Cambiamento' },
  f432: { hz:432, name:'432 Hz Â· Armonia' },
  f528: { hz:528, name:'528 Hz Â· Guarigione' },
  f639: { hz:639, name:'639 Hz Â· Connessione' },
  f741: { hz:741, name:'741 Hz Â· Chiarezza' },
  f852: { hz:852, name:'852 Hz Â· Risveglio' }
};

/* â•â• PERSISTENZA â•â• */
var STORAGE_KEY = 'respira_cfg_v1';
function saveSettings() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      pattern: cfg.pattern, minutes: cfg.minutes,
      track: cfg.track, freq: cfg.freq, vol: cfg.vol
    }));
    return true;
  } catch(e) { dlog('Salvataggio fallito: '+e.message,'error'); return false; }
}
function loadSettings() {
  try {
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    var saved = JSON.parse(raw);
    if (saved.pattern && PATTERNS[saved.pattern]) cfg.pattern = saved.pattern;
    if (saved.minutes) cfg.minutes = saved.minutes;
    if (saved.track && TRACKS[saved.track]) cfg.track = saved.track;
    if (saved.freq && FREQS[saved.freq]) cfg.freq = saved.freq;
    if (typeof saved.vol === 'number') cfg.vol = saved.vol;
    return true;
  } catch(e) { return false; }
}
function applySettingsToUI() {
  qsa('.pattern-card').forEach(function(c){ c.classList.toggle('active', c.dataset.id===cfg.pattern); });
  qsa('.dur-pill').forEach(function(p){ p.classList.toggle('active', parseInt(p.dataset.min)===cfg.minutes); });
  qsa('.track-card').forEach(function(c){ c.classList.toggle('active', c.dataset.tid===cfg.track); });
  qsa('.freq-card').forEach(function(c){ c.classList.toggle('active', c.dataset.fid===cfg.freq); });
  var vs=document.getElementById('volSetup'); if(vs) vs.value=cfg.vol;
}

var cfg  = { pattern:'box', minutes:3, track:'cosmos', freq:'none', vol:0.6 };
var sess = { timer:null, total:0, elapsed:0, phIdx:0, phElapsed:0, cycles:0 };

/* â•â• DEBUG â•â• */
var dbLogs = [];
function dlog(msg, level) {
  var ts = new Date().toTimeString().slice(0,8);
  dbLogs.push('['+ts+'] '+(level?level.toUpperCase()+': ':'')+msg);
  var el = document.getElementById('dbLog');
  if (el) { el.textContent = dbLogs.join('\n'); el.scrollTop = el.scrollHeight; }
  if (level==='error') { var t=document.getElementById('debugToggle'); if(t) t.classList.add('has-error'); }
}
function dset(id, val, cls) {
  var e=document.getElementById(id); if(!e) return;
  e.textContent=val; e.className='debug-val'+(cls?' '+cls:'');
}
function updateDebug() {
  var ua=navigator.userAgent;
  dset('dbUA', ua.length>55?ua.slice(0,55)+'â€¦':ua);
  var isSafari=/Safari/.test(ua)&&!/Chrome/.test(ua), isIOS=/iPhone|iPad|iPod/.test(ua);
  dset('dbSafari',(isSafari?'Safari âœ“':'Non Safari')+(isIOS?' Â· iOS âœ“':' Â· Non iOS'),isSafari||isIOS?'ok':'warn');
  dset('dbRes',window.screen.width+'Ã—'+window.screen.height+' @'+window.devicePixelRatio+'x');
  dset('dbAC', AC?'stato: '+AC.state+(AC.state==='running'?' âœ“':''):'non inizializzato', AC&&AC.state==='running'?'ok':'warn');
  dset('dbSynth', synthActive?'in esecuzione âœ“':'fermo', synthActive?'ok':'warn');
  dset('dbTrack', cfg.track+' Â· '+TRACKS[cfg.track].name);
  dset('dbNodes', activeNodes.length+' nodi Â· freq: '+(cfg.freq==='none'?'off':FREQS[cfg.freq].name));
}

document.getElementById('debugToggle').addEventListener('click',function(){ updateDebug(); document.getElementById('debugPanel').classList.remove('hidden'); });
document.getElementById('debugClose').addEventListener('click',function(){ document.getElementById('debugPanel').classList.add('hidden'); });
document.getElementById('dbCloseBtn').addEventListener('click',function(){ document.getElementById('debugPanel').classList.add('hidden'); });
document.getElementById('dbCopy').addEventListener('click',function(){
  updateDebug();
  var text='=== RESPIRA DEBUG ===\nData: '+new Date().toISOString()+'\n'+dbLogs.join('\n');
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(function(){
      var b=document.getElementById('dbCopy'); b.textContent='âœ“ Copiato';
      setTimeout(function(){b.textContent='Copia log';},2000);
    });
  }
});
function showDebugToggle(show){ document.getElementById('debugToggle').classList.toggle('hidden',!show); }

/* â•â• WEB AUDIO ENGINE â•â• */
var AC=null, masterGain=null, activeNodes=[], synthActive=false, synthTimers=[];
var freqNode=null;
var masterHPF=null, masterComp=null;
var audioOpts = { headphones: true, limiter: true };

function initAC() {
  if (AC) return true;
  try {
    AC = new (window.AudioContext||window.webkitAudioContext)();
    masterGain = AC.createGain();
    masterGain.gain.value = cfg.vol;
    masterHPF = AC.createBiquadFilter();
    masterHPF.type = 'highpass';
    masterHPF.Q.value = 0.5;
    masterComp = AC.createDynamicsCompressor();
    masterComp.threshold.value = -6;
    masterComp.knee.value      = 3;
    masterComp.ratio.value     = 12;
    masterComp.attack.value    = 0.003;
    masterComp.release.value   = 0.18;
    masterGain.connect(masterHPF);
    masterHPF.connect(masterComp);
    masterComp.connect(AC.destination);
    applyAudioProfile();
    dlog('AudioContext OK Â· catena: Gainâ†’HPFâ†’Limiterâ†’Out','ok');
    return true;
  } catch(e) { dlog('AudioContext FALLITO: '+e.message,'error'); return false; }
}

function applyAudioProfile() {
  if (!AC || !masterHPF || !masterComp) return;
  var t = AC.currentTime;
  if (audioOpts.headphones) {
    masterHPF.frequency.setTargetAtTime(30, t, 0.1);
    masterHPF.Q.setTargetAtTime(0.3, t, 0.1);
  } else {
    masterHPF.frequency.setTargetAtTime(120, t, 0.1);
    masterHPF.Q.setTargetAtTime(0.7, t, 0.1);
  }
  if (audioOpts.limiter) {
    masterComp.threshold.setTargetAtTime(-6,  t, 0.05);
    masterComp.ratio.setTargetAtTime(12, t, 0.05);
  } else {
    masterComp.threshold.setTargetAtTime(-1, t, 0.05);
    masterComp.ratio.setTargetAtTime(1, t, 0.05);
  }
  dlog('Profilo audio: '+(audioOpts.headphones?'Cuffie':'Altoparlanti')+' Â· Limiter:'+(audioOpts.limiter?'ON':'OFF'));
}

function resumeAC() { if(AC&&AC.state==='suspended') AC.resume(); }
function setMasterVol(v) {
  cfg.vol=v;
  if(masterGain&&AC) masterGain.gain.setTargetAtTime(v,AC.currentTime,0.1);
}

function startFreqTone(fid) {
  stopFreqTone();
  var f=FREQS[fid];
  if(!f||f.hz===0||!AC||!masterGain) return;
  var g=AC.createGain(); g.gain.setValueAtTime(0,AC.currentTime); g.gain.linearRampToValueAtTime(0.045,AC.currentTime+3.0); g.connect(masterGain);
  var osc=AC.createOscillator(); osc.type='sine'; osc.frequency.value=f.hz;
  var lfo=AC.createOscillator(); lfo.type='sine'; lfo.frequency.value=0.06;
  var lg=AC.createGain(); lg.gain.value=0.008;
  lfo.connect(lg); lg.connect(g.gain); lfo.start(0);
  osc.connect(g); osc.start(0);
  freqNode={osc:osc,gain:g,lfo:lfo,lfoG:lg};
  dlog('Frequenza Solfeggio: '+f.hz+' Hz','ok');
}
function stopFreqTone() {
  if(!freqNode) return;
  try{freqNode.gain.gain.setTargetAtTime(0,AC.currentTime,0.4);}catch(e){}
  var fn=freqNode; freqNode=null;
  setTimeout(function(){ try{fn.osc.stop();}catch(e){} try{fn.lfo.stop();}catch(e){} try{fn.gain.disconnect();}catch(e){} },1200);
}

function mkOsc(type, freq, gain, detune) {
  if(!AC||!masterGain) return null;
  var g=AC.createGain(); g.gain.value=gain; g.connect(masterGain);
  var o=AC.createOscillator(); o.type=type; o.frequency.value=freq;
  if(detune) o.detune.value=detune;
  o.connect(g); o.start(0);
  var node={osc:o,gain:g}; activeNodes.push(node); return node;
}
function mkNoise(gainVal, filterHz, filterQ) {
  if(!AC||!masterGain) return null;
  var len=AC.sampleRate*4;
  var buf=AC.createBuffer(1,len,AC.sampleRate);
  var d=buf.getChannelData(0); for(var i=0;i<len;i++) d[i]=Math.random()*2-1;
  var src=AC.createBufferSource(); src.buffer=buf; src.loop=true;
  var filt=AC.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value=filterHz||400; filt.Q.value=filterQ||0.5;
  var g=AC.createGain(); g.gain.value=gainVal;
  src.connect(filt); filt.connect(g); g.connect(masterGain); src.start(0);
  var node={src:src,gain:g,filt:filt}; activeNodes.push(node); return node;
}
function mkLFO(targetNode, rate, depth, base) {
  if(!AC||!targetNode) return null;
  targetNode.gain.gain.value=base;
  var lfo=AC.createOscillator(); lfo.type='sine'; lfo.frequency.value=rate;
  var lg=AC.createGain(); lg.gain.value=depth;
  lfo.connect(lg); lg.connect(targetNode.gain.gain); lfo.start(0);
  activeNodes.push({osc:lfo,gain:lg}); return lfo;
}
function ringBell(freq, vol) {
  if(!AC||!masterGain) return;
  var t=AC.currentTime;
  var g=AC.createGain(); g.connect(masterGain);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+0.015); g.gain.exponentialRampToValueAtTime(0.0001,t+7.0);
  [[1,1.0],[2.756,0.5],[5.404,0.25],[8.201,0.1]].forEach(function(pair){
    var o=AC.createOscillator(); o.type='sine'; o.frequency.value=freq*pair[0]; o.connect(g); o.start(t); o.stop(t+7.5);
  });
}

function startForest() {
  dlog('Atmosfera: Foresta');
  var p1=mkOsc('sine',55,0.16); var p2=mkOsc('sine',82,0.10,3); var p3=mkOsc('triangle',110,0.06,-5);
  mkNoise(0.055,260,0.7); mkLFO(p1,0.07,0.05,0.16); mkLFO(p2,0.11,0.03,0.10);
  var notes=[55,65.4,73.4,82,98,110]; var ni=0;
  function arpTick(){
    if(!synthActive) return;
    var freq=notes[ni%notes.length]; ni++;
    var n=mkOsc('sine',freq,0);
    if(n){ n.gain.gain.setValueAtTime(0,AC.currentTime); n.gain.gain.linearRampToValueAtTime(0.055,AC.currentTime+1.5); n.gain.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+6); var tid=setTimeout(function(){try{n.osc.stop();}catch(e){}},6500); synthTimers.push(tid); }
    synthTimers.push(setTimeout(arpTick,3500+Math.random()*4500));
  }
  synthTimers.push(setTimeout(arpTick,1500));
}
function startCosmos() {
  dlog('Atmosfera: Cosmo');
  var d1=mkOsc('sine',40,0.18); var d2=mkOsc('sine',60,0.12,8);
  mkOsc('sine',80,0.07,-6); mkOsc('sine',120,0.04,12);
  var s1=mkOsc('sine',320,0.025,0); mkOsc('sine',480,0.015,15);
  mkLFO(d1,0.04,0.06,0.18); mkLFO(d2,0.06,0.04,0.12);
  if(s1) mkLFO(s1,0.15,0.015,0.025);
}
function startOcean() {
  dlog('Atmosfera: Oceano');
  var n1=mkNoise(0.20,700,0.4); var n2=mkNoise(0.08,110,0.3);
  mkOsc('sine',42,0.07); mkOsc('sine',56,0.04,5);
  if(n1&&AC) {
    var lfo1=AC.createOscillator(); lfo1.type='sine'; lfo1.frequency.value=0.10;
    var lg1=AC.createGain(); lg1.gain.value=0.08; lfo1.connect(lg1); lg1.connect(n1.gain.gain); lfo1.start(0); n1.gain.gain.value=0.20; activeNodes.push({osc:lfo1,gain:lg1});
    var lfo2=AC.createOscillator(); lfo2.type='sine'; lfo2.frequency.value=0.17;
    var lg2=AC.createGain(); lg2.gain.value=0.035; lfo2.connect(lg2); lg2.connect(n1.gain.gain); lfo2.start(0); activeNodes.push({osc:lfo2,gain:lg2});
  }
}
function startTemple() {
  dlog('Atmosfera: Tempio');
  var d1=mkOsc('sine',80,0.09); mkOsc('sine',160,0.04,4); mkNoise(0.012,180,0.5);
  if(d1) mkLFO(d1,0.05,0.03,0.09);
  var freqs=[196,220,246.9,261.6,293.7,329.6,392,440];
  function bell(){
    if(!synthActive) return;
    ringBell(freqs[Math.floor(Math.random()*freqs.length)], 0.05+Math.random()*0.04);
    synthTimers.push(setTimeout(bell, 4500+Math.random()*8000));
  }
  synthTimers.push(setTimeout(bell,600));
  synthTimers.push(setTimeout(bell,5000+Math.random()*3000));
}

function stopSynth() {
  synthActive=false;
  if(customOpts.enabled && customLoaded) {
    stopCustomAudioSession();
    synthTimers.forEach(function(t){clearTimeout(t);}); synthTimers=[];
    return;
  }
  synthTimers.forEach(function(t){clearTimeout(t);}); synthTimers=[];
  stopFreqTone();
  if(masterGain&&AC) masterGain.gain.setTargetAtTime(0,AC.currentTime,0.35);
  setTimeout(function(){
    activeNodes.forEach(function(n){
      try{if(n.osc)n.osc.stop();}catch(e){}
      try{if(n.src)n.src.stop();}catch(e){}
      try{if(n.gain)n.gain.disconnect();}catch(e){}
      try{if(n.filt)n.filt.disconnect();}catch(e){}
    });
    activeNodes=[];
    if(masterGain&&AC) masterGain.gain.setValueAtTime(cfg.vol,AC.currentTime);
    dlog('Sintesi fermata');
  },900);
}

function startSynth(trackId, onReady) {
  if(!AC){dlog('AC non disponibile','error');return;}
  if(customOpts.enabled && customLoaded) {
    synthActive=true; activeNodes=[];
    var ok = startCustomAudioSession(onReady);
    if(!ok && onReady) onReady('âš  File non disponibile');
    return;
  }
  resumeAC();
  synthActive=true; activeNodes=[];
  masterGain.gain.setValueAtTime(0,AC.currentTime);
  masterGain.gain.linearRampToValueAtTime(cfg.vol,AC.currentTime+2.2);
  if(trackId==='forest') startForest();
  else if(trackId==='cosmos') startCosmos();
  else if(trackId==='ocean') startOcean();
  else if(trackId==='temple') startTemple();
  else startForest();
  if(cfg.freq!=='none') startFreqTone(cfg.freq);
  var freqLabel = cfg.freq!=='none' ? ' Â· '+FREQS[cfg.freq].name : '';
  dlog('Sintesi avviata: '+TRACKS[trackId].name+freqLabel,'ok');
  if(onReady) onReady('â— '+TRACKS[trackId].name+freqLabel+' Â· in ascolto');
}

document.addEventListener('visibilitychange', function(){
  if (!document.hidden) {
    if (AC && AC.state === 'suspended') AC.resume().then(function(){ dlog('AC resumed (visibility)'); });
    if (sess.timer) {
      if (customOpts.enabled && customLoaded) {
        if (customAudio && customAudio.paused) { customAudio.play().catch(function(){}); dlog('Traccia personale ripresa (visibility)'); }
      } else if (!synthActive) {
        dlog('Riavvio sintesi dopo ritorno app','ok');
        startSynth(cfg.track, function(msg){ var tt=document.getElementById('tickerText'); if(tt) tt.textContent=msg; });
      }
    }
  }
});

document.addEventListener('touchstart',function(){ if(AC&&AC.state==='suspended') AC.resume(); },{passive:true});

/* â•â• PREVIEW â•â• */
var prevTimer=null, prevIdx=0, prevElapsed=0;

function fillType(phaseName) {
  if (phaseName === 'Inspira') return 'top';
  if (phaseName === 'Trattieni' || phaseName === 'Pausa') return 'ltr';
  return 'bottom';
}

function buildPreview(patId){
  var p=PATTERNS[patId], w=document.getElementById('previewBars'); w.innerHTML='';
  p.phases.forEach(function(ph,i){
    var col=mkEl('div','prev-col'); col.id='pv'+i;
    var tr=mkEl('div','prev-track');
    var ft = fillType(ph.n);
    var fiClass = 'prev-fill' + (ft==='top'?' fill-top':ft==='ltr'?' fill-ltr':'');
    var fi=mkEl('div',fiClass); fi.id='pvf'+i;
    fi.style.background=PC[ph.n]||'#c8a26a';
    var countRow = mkEl('div','prev-count-row');
    var numEl = mkEl('div','prev-num'); numEl.id='pvn'+i; numEl.textContent=ph.d;
    var secEl = mkEl('div','prev-sec-lbl'); secEl.textContent='s';
    countRow.appendChild(numEl); countRow.appendChild(secEl);
    var nm=mkEl('div','prev-name'); nm.textContent=ph.n;
    tr.appendChild(fi); col.appendChild(tr); col.appendChild(countRow); col.appendChild(nm);
    w.appendChild(col);
  });
  prevIdx=0; prevElapsed=0;
  if(prevTimer) clearInterval(prevTimer);
  prevTimer=setInterval(tickPrev,1000);
  renderPrev();
}

function tickPrev(){
  var p=PATTERNS[cfg.pattern], ph=p.phases[prevIdx];
  prevElapsed++;
  if(prevElapsed >= ph.d){ prevElapsed=0; prevIdx=(prevIdx+1)%p.phases.length; }
  renderPrev();
}

function renderPrev(){
  var p=PATTERNS[cfg.pattern];
  p.phases.forEach(function(ph,i){
    var f=document.getElementById('pvf'+i), numEl=document.getElementById('pvn'+i);
    if(!f) return;
    var a=i===prevIdx;
    if(numEl){ numEl.textContent=a?(ph.d-prevElapsed):ph.d; numEl.className='prev-num'+(a?' active-num':''); }
    var pct = a ? (prevElapsed/ph.d)*100 : 0;
    var ft = fillType(ph.n);
    if(ft==='ltr'){ f.style.width=a?pct+'%':'0%'; f.style.opacity=a?'1':'0.18'; }
    else if(ft==='top'){ f.style.height=a?pct+'%':'0%'; f.style.opacity=a?'1':'0.18'; }
    else { f.style.height=a?pct+'%':'0%'; f.style.opacity=a?'1':'0.18'; }
  });
}

/* â•â• UI INTERACTIONS â•â• */
qsa('.pattern-card').forEach(function(c){
  c.addEventListener('click',function(){
    qsa('.pattern-card').forEach(function(x){x.classList.remove('active');});
    c.classList.add('active'); cfg.pattern=c.dataset.id; buildPreview(cfg.pattern);
  });
});
qsa('.dur-pill').forEach(function(p){
  p.addEventListener('click',function(){
    qsa('.dur-pill').forEach(function(x){x.classList.remove('active');});
    p.classList.add('active'); cfg.minutes=parseInt(p.dataset.min);
  });
});
qsa('.track-card').forEach(function(c){
  c.addEventListener('click',function(){
    qsa('.track-card').forEach(function(x){x.classList.remove('active');});
    c.classList.add('active'); cfg.track=c.dataset.tid;
  });
});
qsa('.freq-card').forEach(function(c){
  c.addEventListener('click',function(){
    qsa('.freq-card').forEach(function(x){x.classList.remove('active');});
    c.classList.add('active'); cfg.freq=c.dataset.fid;
  });
});
document.getElementById('volSetup').addEventListener('input',function(e){setMasterVol(parseFloat(e.target.value));});
document.getElementById('sessVol').addEventListener('input',function(e){setMasterVol(parseFloat(e.target.value));});

document.getElementById('saveBtn').addEventListener('click',function(){
  var ok = saveSettings();
  var btn = document.getElementById('saveBtn');
  if (ok) {
    btn.classList.add('saved');
    btn.innerHTML='<span class="save-icon">âœ“</span> Impostazioni salvate';
    dlog('Impostazioni salvate','ok');
    setTimeout(function(){ btn.classList.remove('saved'); btn.innerHTML='<span class="save-icon">â†“</span> Salva impostazioni'; },2200);
  }
});

/* â•â• SESSIONE â•â• */
document.getElementById('startBtn').addEventListener('click',function(){ if(!initAC()) return; startSession(); });

function startSession(){
  if(prevTimer){clearInterval(prevTimer);prevTimer=null;}
  var p=PATTERNS[cfg.pattern], t=TRACKS[cfg.track];
  sess.total=cfg.minutes*60; sess.elapsed=0; sess.phIdx=0; sess.phElapsed=0; sess.cycles=0;
  document.getElementById('sessPatLabel').textContent=p.name;
  document.getElementById('sessTrackLabel').textContent=t.name;
  var si=document.getElementById('sessSoundIcon'); if(si) si.textContent=t.icon;
  var pname=document.getElementById('sessPatternName'); if(pname) pname.textContent=p.name;
  var ptext=document.getElementById('sessPatternText'); if(ptext) ptext.textContent=p.desc;
  var psteps=document.getElementById('sessPatternSteps');
  if(psteps){ psteps.innerHTML=''; p.steps.forEach(function(s){ var sp=document.createElement('span'); sp.className='sess-pattern-step'; sp.textContent=s; psteps.appendChild(sp); }); }
  document.getElementById('sessVol').value=cfg.vol;
  document.getElementById('orb1').style.background=p.color;
  document.getElementById('orb2').style.background=t.color;
  buildSessionBars(p); showScreen('session'); showDebugToggle(true);
  document.getElementById('tickerDot').style.background=t.color;
  startSynth(cfg.track,function(msg){ document.getElementById('tickerText').textContent=msg; });
  tick(); sess.timer=setInterval(tick,1000);
}

function sessionFillType(phaseName) {
  if (phaseName === 'Inspira') return 'top';
  if (phaseName === 'Trattieni' || phaseName === 'Pausa') return 'ltr';
  return 'bottom';
}

function buildSessionBars(p){
  var w=document.getElementById('breathBars'); w.innerHTML='';
  p.phases.forEach(function(ph,i){
    var col=mkEl('div','bar-col'+(i===0?' cur':'')); col.id='bc'+i;
    var tr=mkEl('div','bar-track'+(i===0?' cur':'')); tr.id='bt'+i;
    var ft=sessionFillType(ph.n);
    var fiClass='bar-fill'+(ft==='top'?' top-fill':ft==='ltr'?' ltr-fill':'');
    var fi=mkEl('div',fiClass); fi.id='bf'+i;
    var c=PC[ph.n]||'#c8a26a';
    fi.style.background='linear-gradient(180deg,'+c+' 0%,'+rgba(c,.5)+' 100%)';
    var lb=mkEl('div','bar-lbl'); lb.textContent=ph.n;
    tr.appendChild(fi); col.appendChild(tr); col.appendChild(lb); w.appendChild(col);
  });
}

function tick(){
  resumeAC();
  var p=PATTERNS[cfg.pattern], ph=p.phases[sess.phIdx];
  sess.elapsed++; sess.phElapsed++;
  updateSessionUI();
  if(sess.elapsed >= sess.total){ endSession(); return; }
  if(sess.phElapsed >= ph.d){ sess.phElapsed=0; sess.phIdx=(sess.phIdx+1)%p.phases.length; if(sess.phIdx===0) sess.cycles++; }
}

function updateSessionUI(){
  var p=PATTERNS[cfg.pattern], ph=p.phases[sess.phIdx];
  var pPr=sess.phElapsed/ph.d, sPr=sess.elapsed/sess.total;
  var col=PC[ph.n]||p.color;
  document.getElementById('countNum').textContent=sess.phElapsed;
  document.getElementById('countNum').style.color=col;
  document.getElementById('phaseLbl').textContent=ph.n.toUpperCase();
  document.getElementById('phaseLbl').style.color=col;
  document.getElementById('orb1').style.background=col;
  p.phases.forEach(function(phase,i){
    var bc=document.getElementById('bc'+i), bt=document.getElementById('bt'+i), bf=document.getElementById('bf'+i);
    if(!bc||!bt||!bf) return;
    var cur=(i===sess.phIdx);
    bc.classList.toggle('cur',cur); bt.classList.toggle('cur',cur);
    var ft=sessionFillType(phase.n);
    if(ft==='ltr'){ bf.style.height='100%'; bf.style.width=cur?(pPr*100)+'%':'0%'; bf.style.opacity=cur?'1':'0.14'; }
    else { bf.style.width='100%'; bf.style.height=cur?(pPr*100)+'%':'0%'; bf.style.opacity=cur?'1':'0.14'; }
  });
  document.getElementById('progFill').style.width=(sPr*100)+'%';
  var left=sess.total-sess.elapsed;
  document.getElementById('progTime').textContent=Math.floor(left/60)+':'+String(left%60).padStart(2,'0')+' rimasti';
}

function endSession(){
  clearInterval(sess.timer); sess.timer=null; stopSynth(); showDebugToggle(false);
  document.getElementById('statMin').textContent=cfg.minutes;
  document.getElementById('statCycles').textContent=sess.cycles;
  document.getElementById('statTrack').textContent=TRACKS[cfg.track].name;
  showScreen('end');
}

document.getElementById('closeBtn').addEventListener('click',function(){
  clearInterval(sess.timer); sess.timer=null; stopSynth(); showDebugToggle(false);
  showScreen('setup'); setTimeout(function(){buildPreview(cfg.pattern);},120);
});
document.getElementById('againBtn').addEventListener('click',function(){
  showScreen('setup'); setTimeout(function(){buildPreview(cfg.pattern);},120);
});

/* â•â• UTILS â•â• */
function showScreen(id){ qsa('.screen').forEach(function(s){s.classList.add('hidden');}); document.getElementById(id).classList.remove('hidden'); }
function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
function mkEl(tag,cls){ var e=document.createElement(tag); e.className=cls; return e; }
function rgba(hex,a){ var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); return 'rgba('+r+','+g+','+b+','+a.toFixed(2)+')'; }

document.addEventListener('touchmove',function(e){
  if(!e.target.closest('#setup')&&!e.target.closest('input[type=range]')&&!e.target.closest('.debug-scroll')&&!e.target.closest('.debug-log')&&!e.target.closest('.settings-scroll'))
    e.preventDefault();
},{passive:false});

/* â•â• TEMA CHIARO / SCURO â•â• */
var THEME_KEY = 'respira_theme_v1';
var currentTheme = 'dark';

function applyTheme(theme) {
  currentTheme = theme;
  var root = document.documentElement;
  var meta = document.querySelector('meta[name="theme-color"]');
  if (theme === 'light') {
    root.classList.add('light');
    if (meta) meta.setAttribute('content','#f5f0e8');
  } else {
    root.classList.remove('light');
    if (meta) meta.setAttribute('content','#080705');
  }
  var swTh = document.getElementById('swTheme');
  if (swTh) { swTh.classList.toggle('on', theme==='light'); swTh.setAttribute('aria-checked', theme==='light'?'true':'false'); }
  try { localStorage.setItem(THEME_KEY, theme); } catch(e){}
}

(function(){
  var saved;
  try { saved = localStorage.getItem(THEME_KEY); } catch(e){}
  if (!saved) saved = (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';
  applyTheme(saved);
})();

if (window.matchMedia) {
  window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', function(e) {
    var saved; try { saved = localStorage.getItem(THEME_KEY); } catch(ex){}
    if (!saved) applyTheme(e.matches ? 'light' : 'dark');
  });
}

/* â•â• SETTINGS PANEL â•â• */
var SETTINGS_KEY = 'respira_settings_v1';

function openSettings() {
  swSet('swHeadphones', audioOpts.headphones);
  swSet('swLimiter',    audioOpts.limiter);
  swSet('swTheme',      currentTheme === 'light');
  swSet('swCustomTrack', customOpts.enabled);
  updateCustomTrackUI();
  document.getElementById('settingsPanel').classList.remove('hidden');
}
function closeSettings() {
  document.getElementById('settingsPanel').classList.add('hidden');
}

function swSet(id, on) {
  var el = document.getElementById(id); if(!el) return;
  el.classList.toggle('on', on);
  el.setAttribute('aria-checked', on ? 'true' : 'false');
}
function swToggle(id, callback) {
  var el = document.getElementById(id); if(!el) return;
  var next = !el.classList.contains('on');
  swSet(id, next);
  callback(next);
  saveAllSettings();
}

document.getElementById('swHeadphones').addEventListener('click', function(){
  swToggle('swHeadphones', function(on){ audioOpts.headphones=on; applyAudioProfile(); dlog('ModalitÃ : '+(on?'Cuffie':'Altoparlanti')); });
});
document.getElementById('swLimiter').addEventListener('click', function(){
  swToggle('swLimiter', function(on){ audioOpts.limiter=on; applyAudioProfile(); dlog('Limiter: '+(on?'ON':'OFF')); });
});
document.getElementById('swTheme').addEventListener('click', function(){
  swToggle('swTheme', function(on){ applyTheme(on?'light':'dark'); });
});

document.getElementById('gearBtn').addEventListener('click', openSettings);
var gbs = document.getElementById('gearBtnSession');
if (gbs) gbs.addEventListener('click', openSettings);
document.getElementById('settingsClose').addEventListener('click', closeSettings);

/* â•â• TRACCIA PERSONALE â€” IndexedDB â•â• */
var customOpts      = { enabled: false, fileName: null };
var customObjectURL = null;
var customAudio     = null;
var customMediaNode = null;
var customLoaded    = false;

var IDB_NAME = 'respiraDB', IDB_VER = 1, IDB_STORE = 'audioFiles';

function idbOpen(cb) {
  var req = indexedDB.open(IDB_NAME, IDB_VER);
  req.onupgradeneeded = function(e) { var db=e.target.result; if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE,{keyPath:'id'}); };
  req.onsuccess = function(e){ cb(null,e.target.result); };
  req.onerror   = function(e){ cb(e.target.error,null); };
}
function idbSave(name, blob, done) {
  idbOpen(function(err,db){ if(err){dlog('IDB save error: '+err,'error');if(done)done(false);return;} var tx=db.transaction(IDB_STORE,'readwrite'); tx.objectStore(IDB_STORE).put({id:'customTrack',name:name,blob:blob}); tx.oncomplete=function(){db.close();dlog('IDB: salvato â€” '+name,'ok');if(done)done(true);}; tx.onerror=function(){db.close();dlog('IDB write error','error');if(done)done(false);}; });
}
function idbLoad(done) {
  idbOpen(function(err,db){ if(err){if(done)done(null);return;} var req=db.transaction(IDB_STORE,'readonly').objectStore(IDB_STORE).get('customTrack'); req.onsuccess=function(e){db.close();if(done)done(e.target.result||null);}; req.onerror=function(){db.close();if(done)done(null);}; });
}
function idbDelete(done) {
  idbOpen(function(err,db){ if(err){if(done)done();return;} var tx=db.transaction(IDB_STORE,'readwrite'); tx.objectStore(IDB_STORE).delete('customTrack'); tx.oncomplete=function(){db.close();dlog('IDB: file rimosso');if(done)done();}; tx.onerror=function(){db.close();if(done)done();}; });
}

function idbRestoreOnStartup() {
  idbLoad(function(record) {
    if (!record) return;
    dlog('IDB: file trovato â€” '+record.name,'ok');
    applyBlob(record.blob, record.name);
    updateCustomTrackUI();
    swSet('swCustomTrack', customOpts.enabled);
  });
}

function applyBlob(blob, name) {
  if (customObjectURL) URL.revokeObjectURL(customObjectURL);
  customObjectURL = URL.createObjectURL(blob);
  customOpts.fileName = name;
  customLoaded = true;
  showCtLoaded(name, blob.size);
  buildPreviewPlayer(customObjectURL);
}

function showCtEmpty() {
  document.getElementById('ctEmpty').style.display = '';
  document.getElementById('ctLoaded').style.display = 'none';
  var pb=document.getElementById('customPlayBtn'); if(pb){pb.textContent='â–¶';pb.classList.remove('playing');}
}
function showCtLoaded(name, size) {
  document.getElementById('ctEmpty').style.display = 'none';
  document.getElementById('ctLoaded').style.display = '';
  document.getElementById('ctFileName').textContent = name;
  var meta=''; if(size){ if(size>1024*1024) meta=(size/1024/1024).toFixed(1)+' MB'; else meta=Math.round(size/1024)+' KB'; }
  document.getElementById('ctFileMeta').textContent = meta||'file audio';
}

document.getElementById('swCustomTrack').addEventListener('click', function(){
  swToggle('swCustomTrack', function(on){ customOpts.enabled=on; updateCustomTrackUI(); saveAllSettings(); dlog('Traccia personale: '+(on?'ON':'OFF')); });
});
function updateCustomTrackUI() {
  document.getElementById('customTrackArea').classList.toggle('disabled', !customOpts.enabled);
}

document.getElementById('customFileInput').addEventListener('change', function(e){
  var f=e.target.files&&e.target.files[0]; if(f) loadCustomFile(f); this.value='';
});
document.getElementById('ctChangeBtn').addEventListener('click', function(){
  document.getElementById('customFileInput').click();
});
document.getElementById('customUrlBtn').addEventListener('click', function(){ loadCustomUrl(); });
document.getElementById('customUrlInput').addEventListener('keydown', function(e){ if(e.key==='Enter'){this.blur();loadCustomUrl();} });
document.getElementById('customUrlInput').addEventListener('focus', function(){
  var el=this; setTimeout(function(){ el.scrollIntoView({behavior:'smooth',block:'center'}); },350);
});

function loadCustomUrl() {
  var url=(document.getElementById('customUrlInput').value||'').trim();
  if(!url) return;
  if(!/^https?:\/\//i.test(url)){ document.getElementById('customUrlInput').style.borderColor='rgba(176,122,138,.6)'; setTimeout(function(){document.getElementById('customUrlInput').style.borderColor='';},1500); return; }
  var btn=document.getElementById('customUrlBtn'); btn.textContent='â€¦'; btn.disabled=true;
  fetch(url).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.blob(); }).then(function(blob){
    var parts=url.split('/'), name=decodeURIComponent(parts[parts.length-1].split('?')[0])||'traccia.mp3';
    idbSave(name,blob,function(ok){ btn.textContent='Carica'; btn.disabled=false; if(ok){applyBlob(blob,name);document.getElementById('customUrlInput').value='';} else dlog('Errore salvataggio URL blob','error'); });
  }).catch(function(e){ btn.textContent='Carica'; btn.disabled=false; dlog('Errore fetch URL: '+e.message,'error'); document.getElementById('customUrlInput').style.borderColor='rgba(176,122,138,.6)'; setTimeout(function(){document.getElementById('customUrlInput').style.borderColor='';},2000); });
}

function loadCustomFile(file) {
  destroyCustomAudio();
  var lbl=document.querySelector('.ct-pick-main'); if(lbl) lbl.textContent='Salvataggioâ€¦';
  idbSave(file.name,file,function(ok){ if(lbl) lbl.textContent='Scegli dal dispositivo'; if(ok) applyBlob(file,file.name); else dlog('Errore salvataggio file','error'); });
}

function buildPreviewPlayer(src) {
  if(customAudio){customAudio.pause();customAudio.src='';}
  customAudio=new Audio(src); customAudio.loop=true; customAudio.preload='metadata';
  customAudio.addEventListener('timeupdate',onCustomProgress);
  customAudio.addEventListener('loadedmetadata',onCustomProgress);
}
function onCustomProgress() {
  if(!customAudio) return;
  var pct=customAudio.duration?(customAudio.currentTime/customAudio.duration)*100:0;
  var s=Math.floor(customAudio.currentTime);
  var el=document.getElementById('customProgress'), tm=document.getElementById('customTime');
  if(el) el.style.width=pct+'%';
  if(tm) tm.textContent=Math.floor(s/60)+':'+String(s%60).padStart(2,'0');
}

document.getElementById('customPlayBtn').addEventListener('click', function(){
  if(!customAudio) return;
  if(customAudio.paused){customAudio.play();this.textContent='â¸';this.classList.add('playing');}
  else{customAudio.pause();this.textContent='â–¶';this.classList.remove('playing');}
});
document.getElementById('customRemove').addEventListener('click', function(){
  destroyCustomAudio();
  if(customObjectURL){URL.revokeObjectURL(customObjectURL);customObjectURL=null;}
  customLoaded=false; customOpts.fileName=null;
  idbDelete(); showCtEmpty(); dlog('Traccia personale rimossa');
});

function destroyCustomAudio() {
  if(customAudio){ customAudio.pause(); customAudio.removeEventListener('timeupdate',onCustomProgress); customAudio.removeEventListener('loadedmetadata',onCustomProgress); customAudio.src=''; customAudio=null; }
  if(customMediaNode){try{customMediaNode.disconnect();}catch(e){} customMediaNode=null;}
}

function startCustomAudioSession(onReady) {
  if(!customLoaded||!customObjectURL){dlog('Nessun file caricato','warn');return false;}
  if(!AC){dlog('AC non pronto','error');return false;}
  resumeAC();
  if(customAudio&&!customAudio.paused){customAudio.pause();var pb=document.getElementById('customPlayBtn');if(pb){pb.textContent='â–¶';pb.classList.remove('playing');}}
  destroyCustomAudio();
  var sa=new Audio(customObjectURL); sa.loop=true; customAudio=sa;
  customMediaNode=AC.createMediaElementSource(sa); customMediaNode.connect(masterGain);
  sa.volume=0;
  sa.play().then(function(){
    var steps=20,step=0,vol=Math.min(cfg.vol,1);
    var fi=setInterval(function(){step++;sa.volume=Math.min((step/steps)*vol,1);if(step>=steps)clearInterval(fi);},100);
    dlog('Traccia personale avviata: '+customOpts.fileName,'ok');
    if(onReady)onReady('â™« '+customOpts.fileName+' Â· in riproduzione');
  }).catch(function(e){dlog('Play error: '+e.message,'error');});
  return true;
}
function stopCustomAudioSession() {
  if(!customAudio) return;
  var audio=customAudio,steps=10,step=0,sv=audio.volume;
  var fi=setInterval(function(){step++;audio.volume=Math.max(sv*(1-step/steps),0);if(step>=steps){clearInterval(fi);audio.pause();audio.currentTime=0;if(customMediaNode){try{customMediaNode.disconnect();}catch(e){}customMediaNode=null;}if(customObjectURL)buildPreviewPlayer(customObjectURL);}},80);
}

/* â•â• PERSISTENZA IMPOSTAZIONI â•â• */
function saveAllSettings() {
  try { localStorage.setItem(SETTINGS_KEY, JSON.stringify({ headphones:audioOpts.headphones, limiter:audioOpts.limiter, customEnabled:customOpts.enabled })); } catch(e){}
}
function loadAllSettings() {
  try {
    var raw=localStorage.getItem(SETTINGS_KEY); if(!raw) return;
    var s=JSON.parse(raw);
    if(typeof s.headphones==='boolean') audioOpts.headphones=s.headphones;
    if(typeof s.limiter==='boolean') audioOpts.limiter=s.limiter;
    if(typeof s.customEnabled==='boolean') customOpts.enabled=s.customEnabled;
  } catch(e){}
}

/* â•â• INIT â•â• */
dlog('App inizializzata Â· motore sintetico Web Audio API');
var hadSaved = loadSettings();
if(hadSaved) dlog('Impostazioni ripristinate da memoria','ok');
loadAllSettings();
applySettingsToUI();
buildPreview(cfg.pattern);
idbRestoreOnStartup();

</script>

</body>
</html>
